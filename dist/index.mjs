var s=class extends Error{constructor(t){super(t),this.name="InternalRouteHandlerError"}},p=class a{config;middlewares;handleServerError;handleFormData;metadataValue;contextType;constructor({config:t={paramsSchema:void 0,querySchema:void 0,bodySchema:void 0,metadataSchema:void 0},middlewares:n=[],handleServerError:c,handleFormData:d,contextType:u,metadataValue:i}){this.config=t,this.middlewares=n,this.handleServerError=c,this.handleFormData=d,this.contextType=u,this.metadataValue=i}params(t){return new a({config:{...this.config,paramsSchema:t},middlewares:this.middlewares,handleServerError:this.handleServerError,handleFormData:this.handleFormData,contextType:this.contextType,metadataValue:this.metadataValue})}query(t){return new a({config:{...this.config,querySchema:t},middlewares:this.middlewares,handleServerError:this.handleServerError,handleFormData:this.handleFormData,contextType:this.contextType,metadataValue:this.metadataValue})}body(t){return new a({config:{...this.config,bodySchema:t},middlewares:this.middlewares,handleServerError:this.handleServerError,handleFormData:this.handleFormData,contextType:this.contextType,metadataValue:this.metadataValue})}defineMetadata(t){return new a({config:{...this.config,metadataSchema:t},middlewares:this.middlewares,handleServerError:this.handleServerError,handleFormData:this.handleFormData,contextType:this.contextType,metadataValue:void 0})}metadata(t){return new a({...this,metadataValue:t})}use(t){return new a({...this,middlewares:[...this.middlewares,t],contextType:{}})}handler(t){return async(n,c)=>{try{let d=new URL(n.url),u=c?.params?await c.params:{},i=Object.fromEntries([...d.searchParams.keys()].map(e=>{let o=d.searchParams.getAll(e);return o.length===1?[e,o[0]]:[e,o]})),l=this.metadataValue,T={};if(n.method!=="GET"&&n.method!=="DELETE")try{let e=n.headers.get("content-type")||"";if(e.includes("multipart/form-data")||e.includes("application/x-www-form-urlencoded")){let o=await n.formData();T=this.handleFormData?this.handleFormData(o):Object.fromEntries(o.entries())}else T=await n.json()}catch(e){if(this.config.bodySchema)throw new s(JSON.stringify({message:"Invalid body",errors:e}))}if(this.config.paramsSchema){let e=this.config.paramsSchema.safeParse(u);if(!e.success)throw new s(JSON.stringify({message:"Invalid params",errors:e.error.issues}));u=e.data}if(this.config.querySchema){let e=this.config.querySchema.safeParse(i);if(!e.success)throw new s(JSON.stringify({message:"Invalid query",errors:e.error.issues}));i=e.data}if(this.config.bodySchema){let e=this.config.bodySchema.safeParse(T);if(!e.success)throw new s(JSON.stringify({message:"Invalid body",errors:e.error.issues}));T=e.data}if(this.config.metadataSchema&&l!==void 0){let e=this.config.metadataSchema.safeParse(l);if(!e.success)throw new s(JSON.stringify({message:"Invalid metadata",errors:e.error.issues}));l=e.data}let m={},y=async e=>{if(e>=this.middlewares.length)try{let r=await t(n,{params:u,query:i,body:T,ctx:m,metadata:l});return r instanceof Response?r:new Response(JSON.stringify(r),{status:200,headers:{"Content-Type":"application/json"}})}catch(r){return h(r,this.handleServerError)}let o=this.middlewares[e];if(!o)return y(e+1);let w=async(r={})=>(r.ctx&&(m={...m,...r.ctx}),await y(e+1));try{let r=await o({request:n,params:u,query:i,body:T,ctx:m,metadata:l,next:w});return r instanceof Response||(m={...m}),r}catch(r){return h(r,this.handleServerError)}};return y(0)}catch(d){return h(d,this.handleServerError)}}}},h=(a,t)=>a instanceof s?new Response(a.message,{status:400}):t?t(a):new Response(JSON.stringify({message:"Internal server error"}),{status:500});function f(a){return new p({handleServerError:a?.handleServerError,handleFormData:a?.handleFormData,contextType:{}})}export{f as createZodRoute};
//# sourceMappingURL=index.mjs.map