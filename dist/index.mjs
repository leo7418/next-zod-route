var o=class extends Error{constructor(a){super(a),this.name="InternalRouteHandlerError"}},l=class t{config;middlewares;handleServerError;handleFormData;metadataValue;contextType;constructor({config:a={paramsSchema:void 0,querySchema:void 0,bodySchema:void 0,metadataSchema:void 0},middlewares:n=[],handleServerError:h,handleFormData:i,contextType:d,metadataValue:c}){this.config=a,this.middlewares=n,this.handleServerError=h,this.handleFormData=i,this.contextType=d,this.metadataValue=c}params(a){return new t({...this,config:{...this.config,paramsSchema:a}})}query(a){return new t({...this,config:{...this.config,querySchema:a}})}body(a){return new t({...this,config:{...this.config,bodySchema:a}})}defineMetadata(a){return new t({...this,config:{...this.config,metadataSchema:a}})}metadata(a){return new t({...this,metadataValue:a})}use(a){return new t({...this,middlewares:[...this.middlewares,a],contextType:{}})}handler(a){return async(n,h)=>{try{let i=new URL(n.url),d=h?.params?await h.params:{},c=Object.fromEntries([...i.searchParams.keys()].map(e=>{let s=i.searchParams.getAll(e);return s.length===1?[e,s[0]]:[e,s]})),T=this.metadataValue,m={};if(n.method!=="GET"&&n.method!=="DELETE")try{let e=n.headers.get("content-type")||"";if(e.includes("multipart/form-data")||e.includes("application/x-www-form-urlencoded")){let s=await n.formData();m=this.handleFormData?this.handleFormData(s):Object.fromEntries(s.entries())}else m=await n.json()}catch(e){if(this.config.bodySchema)throw new o(JSON.stringify({message:"Invalid body",errors:e}))}if(this.config.paramsSchema){let e=this.config.paramsSchema.safeParse(d);if(!e.success)throw new o(JSON.stringify({message:"Invalid params",errors:e.error.issues}));d=e.data}if(this.config.querySchema){let e=this.config.querySchema.safeParse(c);if(!e.success)throw new o(JSON.stringify({message:"Invalid query",errors:e.error.issues}));c=e.data}if(this.config.bodySchema){let e=this.config.bodySchema.safeParse(m);if(!e.success)throw new o(JSON.stringify({message:"Invalid body",errors:e.error.issues}));m=e.data}if(this.config.metadataSchema&&T!==void 0){let e=this.config.metadataSchema.safeParse(T);if(!e.success)throw new o(JSON.stringify({message:"Invalid metadata",errors:e.error.issues}));T=e.data}let u={},f=async e=>{if(e>=this.middlewares.length)try{let r=await a(n,{params:d,query:c,body:m,ctx:u,metadata:T});return r instanceof Response?r:new Response(JSON.stringify(r),{status:200,headers:{"Content-Type":"application/json"}})}catch(r){return y(r,this.handleServerError)}let s=this.middlewares[e];if(!s)return f(e+1);let S=async(r={})=>(r.ctx&&(u={...u,...r.ctx}),await f(e+1));try{let r=await s({request:n,params:d,query:c,body:m,ctx:u,metadata:T,next:S});return r instanceof Response||(u={...u}),r}catch(r){return y(r,this.handleServerError)}};return f(0)}catch(i){return y(i,this.handleServerError)}}}},y=(t,a)=>t instanceof o?new Response(t.message,{status:400}):a?a(t):new Response(JSON.stringify({message:"Internal server error"}),{status:500});function w(t){return new l({handleServerError:t?.handleServerError,contextType:{}})}export{w as createZodRoute};
//# sourceMappingURL=index.mjs.map